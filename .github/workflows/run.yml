# Daily arXiv AI Enhanced - GitHub Actions Workflow
# Copyright 2026 Jonghwan Kim
# 
# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: arXiv-daily-ai-enhanced # actions workflow name

on:
  schedule:
    # Runs at 21:00 UTC (6 AM KST) every day --Modified by Jonghwan Kim on 2026-01-30
    - cron: "0 21 * * *"
  workflow_dispatch:


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync
        
    - name: Crawl arXiv papers
      id: crawl_step
      run: |
        source .venv/bin/activate
        today=$(date -u "+%Y-%m-%d")
        echo "Starting to crawl $today arXiv papers..."
        
        # Check if today's file exists, delete if found
        if [ -f "data/${today}.jsonl" ]; then
            echo "Found existing today's file, deleting for fresh start..."
            rm "data/${today}.jsonl"
            echo "Deleted existing file: data/${today}.jsonl"
        else
            echo "Today's file doesn't exist, ready to create new one..."
        fi
        
        cd daily_arxiv
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export TOKEN_GITHUB=${{ secrets.TOKEN_GITHUB }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export CATEGORIES="${{ vars.CATEGORIES }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"
        
        # Use Scrapy to crawl
        scrapy crawl arxiv -o ../data/${today}.jsonl
        
        # Check if crawling was successful
        if [ ! -f "../data/${today}.jsonl" ]; then
            echo "Crawling failed, no data file generated"
            exit 1
        fi
        
        echo "crawl_date=$today" >> $GITHUB_OUTPUT
        echo "Crawling completed"
        
    - name: Check for duplicates
      id: dedup_check
      run: |
        source .venv/bin/activate
        echo "Performing intelligent deduplication check..."
        
        cd daily_arxiv
        # Execute intelligent deduplication check script
        set +e  # Temporarily allow command failure
        python daily_arxiv/check_stats.py
        
        # Get exit code
        dedup_exit_code=$?
        set -e  # Restore strict mode
        
        echo "Dedup check exit code: $dedup_exit_code"
        echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT
        
        case $dedup_exit_code in
            0)
                echo "has_new_content=true" >> $GITHUB_OUTPUT
                ;;
            1)
                echo "has_new_content=false" >> $GITHUB_OUTPUT
                echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
                ;;
            2)
                echo "has_new_content=false" >> $GITHUB_OUTPUT
                echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
                exit 1
                ;;
            *)
                echo "Unknown exit code, stop workflow"
                echo "has_new_content=false" >> $GITHUB_OUTPUT
                echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
                exit 1
                ;;
        esac
        
    - name: AI Enhancement Processing
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        source .venv/bin/activate
        today=${{ steps.crawl_step.outputs.crawl_date }}
        echo "Starting AI enhancement processing..."
        
        cd ai
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"
        
        python enhance.py --data ../data/${today}.jsonl
        
        # Check if AI processing was successful
        if [ $? -ne 0 ]; then
            echo "AI processing failed"
            exit 1
        fi
        echo "AI enhancement processing completed"
        
    - name: Convert to Markdown
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        source .venv/bin/activate
        today=${{ steps.crawl_step.outputs.crawl_date }}
        echo "Converting to Markdown format..."
        
        # Set environment variables
        export LANGUAGE="${{ vars.LANGUAGE }}"
        
        cd to_md
        
        # Use AI enhanced file for conversion
        AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"
        
        if [ -f "$AI_FILE" ]; then
            echo "Using AI enhanced file for conversion..."
            python convert.py --data "$AI_FILE"
        else
            echo "Error: AI enhanced file not found"
            echo "AI file: $AI_FILE"
            exit 1
        fi
        
        # Check if conversion was successful
        if [ $? -ne 0 ]; then
            echo "Markdown conversion failed"
            exit 1
        fi
        echo "Markdown conversion completed"
        
    - name: Update file list
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "Updating file list..."
        ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
        echo "File list updated"

    - name: Generate password hash and inject into config
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "ðŸ” Generating password hash for authentication..."

        PASSWORD="${{ secrets.ACCESS_PASSWORD }}"

        if [ -z "$PASSWORD" ]; then
          echo "âš ï¸  WARNING: ACCESS_PASSWORD not set in Secrets"
          echo "âš ï¸  Password protection will be DISABLED"
          echo "âš ï¸  To enable password protection, add ACCESS_PASSWORD in repository Secrets"
          echo "â„¹ï¸  Website will remain publicly accessible without authentication"

          # Use a special value that will disable authentication
          PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_SECRETS"
        else
          # Generate SHA-256 hash using openssl
          PASSWORD_HASH=$(echo -n "$PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
          echo "âœ… Password hash generated successfully"
          echo "âœ… Hash length: ${#PASSWORD_HASH} characters"
          echo "ðŸ” Password protection is ENABLED"
        fi

        # Inject hash into auth-config.js
        if [ -f "js/auth-config.js" ]; then
          sed -i "s/PLACEHOLDER_PASSWORD_HASH/$PASSWORD_HASH/" js/auth-config.js
          echo "âœ… Password hash injected into js/auth-config.js"
        else
          echo "âŒ ERROR: js/auth-config.js not found!"
          exit 1
        fi

        echo "ðŸ” Authentication setup complete"

    - name: Summary
      run: |
        if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
          echo "âœ… Workflow completed: Smart deduplication found new content and processed successfully"
        else
          case "${{ steps.dedup_check.outputs.skip_reason }}" in
            "no_new_content")
              echo "â„¹ï¸ Workflow completed: No new content after smart deduplication"
              ;;
            "processing_error")
              echo "âš ï¸ Workflow completed: Deduplication processing error"
              ;;
            "unknown_error")
              echo "âš ï¸ Workflow completed: Unknown error"
              ;;
            *)
              echo "â„¹ï¸ Workflow completed: Skipped for unknown reason"
              ;;
          esac
        fi
        
    - name: Inject repository info into data-config.js
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "Injecting repository info into data-config.js..."
        
        # Get repository information
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        echo "Repository owner: $REPO_OWNER"
        echo "Repository name: $REPO_NAME"
        
        # Inject repository info into data-config.js
        if [ -f "js/data-config.js" ]; then
          sed -i "s/PLACEHOLDER_REPO_OWNER/$REPO_OWNER/g" js/data-config.js
          sed -i "s/PLACEHOLDER_REPO_NAME/$REPO_NAME/g" js/data-config.js
          echo "âœ… Repository info injected into js/data-config.js"
        else
          echo "âŒ ERROR: js/data-config.js not found!"
          exit 1
        fi

    - name: Commit code changes to main branch
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        
        # Add all code files, but exclude data files
        git add js/data-config.js
        git add .github/
        # Add other possible code changes, but exclude data/ directory and assets/file-list.txt
        git add -A
        git reset -- data/* assets/file-list.txt 2>/dev/null || true
        
        # Check if there are code changes to commit
        if git diff --staged --quiet; then
          echo "No code changes to commit"
        else
          git commit -m "chore: update data-config.js with repository info"
          echo "Code changes committed to main branch"
        fi

    - name: Push code changes to main branch
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        # Set Git config for automatic merging
        git config pull.rebase true
        git config rebase.autoStash true
        
        # Try to push code changes to main branch
        for i in {1..3}; do
          echo "Push code changes attempt $i"
          if git push origin main; then
            echo "Code changes pushed successfully"
            break
          else
            echo "Push failed, pulling latest changes..."
            git pull origin main --no-edit || true
            if [ $i -eq 3 ]; then
              echo "Failed to push after 3 attempts"
              exit 1
            fi
          fi
        done

    - name: Prepare data files for data branch
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "Preparing data files..."
        today=${{ steps.crawl_step.outputs.crawl_date }}
        
        # Create temporary directory to save data files
        mkdir -p /tmp/data_files/data
        mkdir -p /tmp/data_files/assets
        
        # Copy data files to temporary directory
        cp -r data/* /tmp/data_files/data/ 2>/dev/null || true
        cp assets/file-list.txt /tmp/data_files/assets/ 2>/dev/null || true
        
        echo "Data files saved to temporary directory"

    - name: Setup and commit to data branch
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        
        echo "Setting up data branch..."
        today=${{ steps.crawl_step.outputs.crawl_date }}
        
        # Before switching branches, clean untracked files that might conflict
        # Before switching branches, clean untracked files that might conflict
        # These files are already saved to temporary directory, so safe to remove
        rm -rf data/*.jsonl 2>/dev/null || true
        rm -f assets/file-list.txt 2>/dev/null || true
        
        # Check if data branch exists
        if git ls-remote --heads origin data | grep -q data; then
          echo "Data branch exists, switching to data branch"
          git fetch origin data:data
          git checkout data
          git pull origin data || true
        else
          echo "Data branch does not exist, creating new branch"
          # Create empty data branch
          git checkout --orphan data
          git rm -rf --cached . 2>/dev/null || true
          # Ensure data and assets directories exist
          mkdir -p data assets
          echo "# Data Branch" > README.md
          git add README.md
          git commit -m "chore: initialize data branch"
          git push origin data
        fi
        
        # Restore data files from temporary directory
        # Ensure directories exist
        mkdir -p data assets
        cp -r /tmp/data_files/data/* data/ 2>/dev/null || true
        cp /tmp/data_files/assets/file-list.txt assets/ 2>/dev/null || true
        
        # Only add data files
        git add data/* 2>/dev/null || true
        git add assets/file-list.txt 2>/dev/null || true
        
        # Check if there are data changes to commit
        if git diff --staged --quiet; then
          echo "No data changes to commit"
        else
          git commit -m "update: $today arXiv papers"
          echo "Data changes committed to data branch"
        fi

    - name: Push data changes to data branch
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        # Set Git config for automatic merging
        git config pull.rebase true
        git config rebase.autoStash true
        
        # Try to push data changes to data branch
        for i in {1..3}; do
          echo "Push data changes attempt $i"
          if git push origin data; then
            echo "Data changes pushed successfully"
            break
          else
            echo "Push failed, pulling latest changes..."
            git pull origin data --no-edit || true
            if [ $i -eq 3 ]; then
              echo "Failed to push after 3 attempts"
              exit 1
            fi
          fi
        done
